import { defineStore } from "/node_modules/.vite/deps/pinia.js?v=84e5e045";
import { Session, URI, UserAgent, Inviter, Invitation, Notification } from "/node_modules/.vite/deps/sip__js.js?v=84e5e045";
import { ref } from "/node_modules/.vite/deps/vue.js?v=84e5e045";
export const useSipStore = defineStore("sip", () => {
  const userAgent = ref();
  const voicemail = ref({ new: 0, old: 0 });
  const isDnd = ref(false);
  const simpleuUser = ref;
  const isRegistered = ref(false);
  const isConnected = ref(false);
  const currentCall = ref(null);
  const incomingCall = ref(null);
  const callState = ref("idle");
  const connectionState = ref("disconnected");
  const callStartTime = ref(null);
  const error = ref(null);
  const isMuted = ref(false);
  const sipConfig = ref({
    server: "wss://hornblower.doesnotexist.com:7443",
    username: "",
    password: "",
    domain: "hornblower.doesnotexist.com",
    displayName: ""
  });
  const initializeSip = async (config) => {
    try {
      sipConfig.value = { ...sipConfig.value, ...config };
      connectionState.value = "connecting";
      error.value = null;
      const uri = new URI("sip", sipConfig.value.username, sipConfig.value.domain, 5060);
      const transportOptions = {
        server: "wss://hornblower.doesnotexist.com:7443",
        connectionTimeout: 1e4,
        keepAliveInterval: 3e4,
        traceSip: true
      };
      const userAgentOptions = {
        uri,
        transportOptions,
        userAgentString: "SIP.js/0.7.8 SaraPhone 04",
        traceSip: true,
        iceCheckingTimeout: 1e3,
        registerExpires: 120,
        allowLegacyNotifications: true,
        hackWssInTransport: true,
        wsServerMaxReconnection: 5e3,
        wsServerReconnectionTimeout: 1,
        connectionRecoveryMaxInterval: 3,
        connectionRecoveryMinInterval: 2,
        delegate: {
          onConnect: () => {
            console.log("SIP conectado");
            isConnected.value = true;
            connectionState.value = "connected";
          },
          onDisconnect: (error2) => {
            console.log("SIP desconectado", error2);
            isConnected.value = false;
            isRegistered.value = false;
            connectionState.value = "disconnected";
            if (error2) {
              connectionState.value = "reconnecting";
              setTimeout(() => {
                if (userAgent.value) {
                  userAgent.value.start();
                }
              }, 5e3);
            }
          },
          onInvite: (invitation) => {
            if (isDnd.value) {
              console.log("Llamada entrante ignorada por DND");
              invitation.reject();
              return;
            }
            currentCall.value = invitation;
            callState.value = "ringing";
          }
        }
      };
      const simpleUserOptions = {
        delegate: simpleUserDelegate,
        media: {
          remote: {
            audio: audioElement
          }
        },
        userAgentOptions: {
          // logLevel: "debug",
          displayName
        }
      };
      const simpleUser = new SimpleUser(webSocketServer, simpleUserOptions);
      userAgent.value = new UserAgent(userAgentOptions);
      userAgent.value.delegate = {
        ...userAgent.value.delegate,
        onNotify: (notification) => {
          const body = notification.request.body;
          const match = body.match(/voice-message:\s*(\d+)\/(\d+)/i);
          if (match) {
            const newMessages = parseInt(match[1] ?? "0");
            const oldMessages = parseInt(match[2] ?? "0");
            voicemail.value = { new: newMessages, old: oldMessages };
          }
          notification.accept();
        }
      };
      await userAgent.value.start();
    } catch (err) {
      console.error("Error inicializando SIP:", err);
      connectionState.value = "disconnected";
    }
  };
  const makeCall = async (number) => {
    try {
      if (!userAgent.value || !isConnected.value) {
        throw new Error("SIP no estÃ¡ conectado");
      }
      const target = new URI("sip", number, sipConfig.value.domain);
      currentCall.value = new Inviter(userAgent.value, target);
      callState.value = "calling";
      callStartTime.value = /* @__PURE__ */ new Date();
      currentCall.value.stateChange.addListener((state) => {
        if (state === "Establishing") {
          console.log("Llamada creada");
        }
        if (state === "Established") {
          console.log("Llamada contestada");
          callState.value = "connected";
        }
        if (state === "Terminated") {
          console.log("Llamada terminada");
          callState.value = "ended";
          currentCall.value = null;
          callStartTime.value = null;
        }
      });
      await currentCall.value.invite();
      return true;
    } catch (err) {
      console.error("Error haciendo llamada:", err);
      callState.value = "idle";
      currentCall.value = null;
      return false;
    }
  };
  const endCall = async () => {
    try {
      if (currentCall.value) {
        if (currentCall.value instanceof Inviter) {
          await currentCall.value.cancel();
        } else {
        }
      }
      callState.value = "ended";
      currentCall.value = null;
      callStartTime.value = null;
    } catch (err) {
      console.error("Error terminando llamada:", err);
    }
  };
  const muteCall = async () => {
    try {
      if (currentCall.value && callState.value === "connected") {
        const inv = currentCall.value;
        const session = inv;
        session.mute();
        const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioTracks = mediaStream.getAudioTracks();
        audioTracks.forEach((track) => {
          track.enabled = false;
        });
        isMuted.value = true;
      }
    } catch (err) {
      console.error("Error muting call:", err);
    }
  };
  const unmuteCall = async () => {
    try {
      if (currentCall.value && callState.value === "connected") {
        const session = currentCall.value;
        if (session && typeof session.unmute === "function") {
          session.unmute();
          isMuted.value = false;
          console.log("Call unmuted");
        } else {
          const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const audioTracks = mediaStream.getAudioTracks();
          audioTracks.forEach((track) => {
            track.enabled = true;
          });
          isMuted.value = false;
        }
      }
    } catch (err) {
      console.error("Error unmuting call:", err);
    }
  };
  const toggleMute = async () => {
    if (isMuted.value) {
      await unmuteCall();
    } else {
      await muteCall();
    }
  };
  return {
    userAgent,
    isRegistered,
    isConnected,
    connectionState,
    error,
    sipConfig,
    currentCall,
    incomingCall,
    voicemail,
    isDnd,
    callState,
    callStartTime,
    makeCall,
    endCall,
    initializeSip
  };
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNpcFN0b3JlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlZmluZVN0b3JlIH0gZnJvbSAncGluaWEnXHJcbmltcG9ydCB7IFNlc3Npb24sIFVSSSwgVXNlckFnZW50LCBJbnZpdGVyLCBJbnZpdGF0aW9uLCBOb3RpZmljYXRpb24gfSBmcm9tICdzaXAuanMnXHJcbmltcG9ydCB0eXBlIHsgU2ltcGxlVXNlciB9IGZyb20gJ3NpcC5qcy9saWIvcGxhdGZvcm0vd2ViJ1xyXG5pbXBvcnQgeyByZWYgfSBmcm9tICd2dWUnXHJcblxyXG5leHBvcnQgY29uc3QgdXNlU2lwU3RvcmUgPSBkZWZpbmVTdG9yZSgnc2lwJywgKCkgPT4ge1xyXG4gIGNvbnN0IHVzZXJBZ2VudCA9IHJlZigpXHJcbiAgLy8gY29uc3QgcmVnaXN0ZXJlciA9IHJlZihudWxsKVxyXG4gIGNvbnN0IHZvaWNlbWFpbCA9IHJlZih7IG5ldzogMCwgb2xkOiAwIH0pXHJcbiAgY29uc3QgaXNEbmQgPSByZWYoZmFsc2UpXHJcbiAgY29uc3Qgc2ltcGxldVVzZXIgPSByZWY8U2ltcGxlVXNlcj5cclxuICBjb25zdCBpc1JlZ2lzdGVyZWQgPSByZWYoZmFsc2UpXHJcbiAgY29uc3QgaXNDb25uZWN0ZWQgPSByZWYoZmFsc2UpXHJcbiAgY29uc3QgY3VycmVudENhbGwgPSByZWY8SW52aXRlciB8IEludml0YXRpb24gfCBudWxsPihudWxsKVxyXG4gIGNvbnN0IGluY29taW5nQ2FsbCA9IHJlZjxJbnZpdGF0aW9uIHwgbnVsbD4obnVsbClcclxuICBjb25zdCBjYWxsU3RhdGUgPSByZWY8J2lkbGUnIHwgJ2NhbGxpbmcnIHwgJ3JpbmdpbmcnIHwgJ2Nvbm5lY3RlZCcgfCAnZW5kZWQnPignaWRsZScpXHJcbiAgY29uc3QgY29ubmVjdGlvblN0YXRlID0gcmVmKCdkaXNjb25uZWN0ZWQnKSAvLyBkaXNjb25uZWN0ZWQsIGNvbm5lY3RpbmcsIGNvbm5lY3RlZCwgcmVjb25uZWN0aW5nXHJcbiAgY29uc3QgY2FsbFN0YXJ0VGltZSA9IHJlZjxEYXRlIHwgbnVsbD4obnVsbClcclxuICBjb25zdCBlcnJvciA9IHJlZihudWxsKVxyXG4gIGNvbnN0IGlzTXV0ZWQgPSByZWYoZmFsc2UpXHJcblxyXG4gIC8vIGNvbnN0IGF1ZGlvRWxlbWVudCA9IHJlZihudWxsKVxyXG5cclxuICBjb25zdCBzaXBDb25maWcgPSByZWYoe1xyXG4gICAgc2VydmVyOiAnd3NzOi8vaG9ybmJsb3dlci5kb2Vzbm90ZXhpc3QuY29tOjc0NDMnLFxyXG4gICAgdXNlcm5hbWU6ICcnLFxyXG4gICAgcGFzc3dvcmQ6ICcnLFxyXG4gICAgZG9tYWluOiAnaG9ybmJsb3dlci5kb2Vzbm90ZXhpc3QuY29tJyxcclxuICAgIGRpc3BsYXlOYW1lOiAnJyxcclxuICB9KVxyXG5cclxuICBjb25zdCBpbml0aWFsaXplU2lwID0gYXN5bmMgKFxyXG4gICAgY29uZmlnOlxyXG4gICAgICB8IHsgc2VydmVyOiBzdHJpbmc7IHVzZXJuYW1lOiBzdHJpbmc7IHBhc3N3b3JkOiBzdHJpbmc7IGRvbWFpbjogc3RyaW5nOyBkaXNwbGF5TmFtZTogc3RyaW5nIH1cclxuICAgICAgfCB7IHNlcnZlcjogc3RyaW5nOyB1c2VybmFtZTogc3RyaW5nOyBwYXNzd29yZDogc3RyaW5nOyBkb21haW46IHN0cmluZzsgZGlzcGxheU5hbWU6IHN0cmluZyB9LFxyXG4gICkgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gQWN0dWFsaXphciBjb25maWd1cmFjacOzblxyXG4gICAgICBzaXBDb25maWcudmFsdWUgPSB7IC4uLnNpcENvbmZpZy52YWx1ZSwgLi4uY29uZmlnIH1cclxuXHJcbiAgICAgIGNvbm5lY3Rpb25TdGF0ZS52YWx1ZSA9ICdjb25uZWN0aW5nJ1xyXG4gICAgICBlcnJvci52YWx1ZSA9IG51bGxcclxuXHJcbiAgICAgIC8vIENyZWFyIFVzZXJBZ2VudFxyXG4gICAgICBjb25zdCB1cmkgPSBuZXcgVVJJKCdzaXAnLCBzaXBDb25maWcudmFsdWUudXNlcm5hbWUsIHNpcENvbmZpZy52YWx1ZS5kb21haW4sIDUwNjApXHJcbiAgICAgIGNvbnN0IHRyYW5zcG9ydE9wdGlvbnMgPSB7XHJcbiAgICAgICAgc2VydmVyOiAnd3NzOi8vaG9ybmJsb3dlci5kb2Vzbm90ZXhpc3QuY29tOjc0NDMnLFxyXG4gICAgICAgIGNvbm5lY3Rpb25UaW1lb3V0OiAxMDAwMCxcclxuICAgICAgICBrZWVwQWxpdmVJbnRlcnZhbDogMzAwMDAsXHJcbiAgICAgICAgdHJhY2VTaXA6IHRydWUsXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHVzZXJBZ2VudE9wdGlvbnMgPSB7XHJcbiAgICAgICAgdXJpLFxyXG4gICAgICAgIHRyYW5zcG9ydE9wdGlvbnMsXHJcbiAgICAgICAgdXNlckFnZW50U3RyaW5nOiAnU0lQLmpzLzAuNy44IFNhcmFQaG9uZSAwNCcsXHJcbiAgICAgICAgdHJhY2VTaXA6IHRydWUsXHJcbiAgICAgICAgaWNlQ2hlY2tpbmdUaW1lb3V0OiAxMDAwLFxyXG4gICAgICAgIHJlZ2lzdGVyRXhwaXJlczogMTIwLFxyXG4gICAgICAgIGFsbG93TGVnYWN5Tm90aWZpY2F0aW9uczogdHJ1ZSxcclxuICAgICAgICBoYWNrV3NzSW5UcmFuc3BvcnQ6IHRydWUsXHJcbiAgICAgICAgd3NTZXJ2ZXJNYXhSZWNvbm5lY3Rpb246IDUwMDAsXHJcbiAgICAgICAgd3NTZXJ2ZXJSZWNvbm5lY3Rpb25UaW1lb3V0OiAxLFxyXG4gICAgICAgIGNvbm5lY3Rpb25SZWNvdmVyeU1heEludGVydmFsOiAzLFxyXG4gICAgICAgIGNvbm5lY3Rpb25SZWNvdmVyeU1pbkludGVydmFsOiAyLFxyXG4gICAgICAgIGRlbGVnYXRlOiB7XHJcbiAgICAgICAgICBvbkNvbm5lY3Q6ICgpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1NJUCBjb25lY3RhZG8nKVxyXG4gICAgICAgICAgICBpc0Nvbm5lY3RlZC52YWx1ZSA9IHRydWVcclxuICAgICAgICAgICAgY29ubmVjdGlvblN0YXRlLnZhbHVlID0gJ2Nvbm5lY3RlZCdcclxuICAgICAgICAgICAgLy8gcmVnaXN0ZXIoKVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIG9uRGlzY29ubmVjdDogKGVycm9yOiB1bmtub3duKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTSVAgZGVzY29uZWN0YWRvJywgZXJyb3IpXHJcbiAgICAgICAgICAgIGlzQ29ubmVjdGVkLnZhbHVlID0gZmFsc2VcclxuICAgICAgICAgICAgaXNSZWdpc3RlcmVkLnZhbHVlID0gZmFsc2VcclxuICAgICAgICAgICAgY29ubmVjdGlvblN0YXRlLnZhbHVlID0gJ2Rpc2Nvbm5lY3RlZCdcclxuICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgY29ubmVjdGlvblN0YXRlLnZhbHVlID0gJ3JlY29ubmVjdGluZydcclxuICAgICAgICAgICAgICAvLyBJbnRlbnRhciByZWNvbmVjdGFyIGRlc3B1w6lzIGRlIDUgc2VndW5kb3NcclxuICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh1c2VyQWdlbnQudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgdXNlckFnZW50LnZhbHVlLnN0YXJ0KClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9LCA1MDAwKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgb25JbnZpdGU6IChpbnZpdGF0aW9uOiBJbnZpdGF0aW9uKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChpc0RuZC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdMbGFtYWRhIGVudHJhbnRlIGlnbm9yYWRhIHBvciBETkQnKVxyXG4gICAgICAgICAgICAgIGludml0YXRpb24ucmVqZWN0KClcclxuICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjdXJyZW50Q2FsbC52YWx1ZSA9IGludml0YXRpb25cclxuICAgICAgICAgICAgY2FsbFN0YXRlLnZhbHVlID0gJ3JpbmdpbmcnXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHNpbXBsZVVzZXJPcHRpb25zOiBTaW1wbGVVc2VyT3B0aW9ucyA9IHtcclxuICBkZWxlZ2F0ZTogc2ltcGxlVXNlckRlbGVnYXRlLFxyXG4gIG1lZGlhOiB7XHJcbiAgICByZW1vdGU6IHtcclxuICAgICAgYXVkaW86IGF1ZGlvRWxlbWVudFxyXG4gICAgfVxyXG4gIH0sXHJcbiAgdXNlckFnZW50T3B0aW9uczoge1xyXG4gICAgLy8gbG9nTGV2ZWw6IFwiZGVidWdcIixcclxuICAgIGRpc3BsYXlOYW1lXHJcbiAgfVxyXG59O1xyXG5cclxuLy8gU2ltcGxlVXNlciBjb25zdHJ1Y3Rpb25cclxuY29uc3Qgc2ltcGxlVXNlciA9IG5ldyBTaW1wbGVVc2VyKHdlYlNvY2tldFNlcnZlciwgc2ltcGxlVXNlck9wdGlvbnMpO1xyXG5cclxuICAgICAgdXNlckFnZW50LnZhbHVlID0gbmV3IFVzZXJBZ2VudCh1c2VyQWdlbnRPcHRpb25zKVxyXG5cclxuICAgICAgdXNlckFnZW50LnZhbHVlLmRlbGVnYXRlID0ge1xyXG4gICAgICAgIC4uLnVzZXJBZ2VudC52YWx1ZS5kZWxlZ2F0ZSxcclxuICAgICAgICBvbk5vdGlmeTogKG5vdGlmaWNhdGlvbjogTm90aWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBib2R5ID0gbm90aWZpY2F0aW9uLnJlcXVlc3QuYm9keVxyXG4gICAgICAgICAgY29uc3QgbWF0Y2ggPSBib2R5Lm1hdGNoKC92b2ljZS1tZXNzYWdlOlxccyooXFxkKylcXC8oXFxkKykvaSlcclxuXHJcbiAgICAgICAgICBpZiAobWF0Y2gpIHtcclxuICAgICAgICAgICAgY29uc3QgbmV3TWVzc2FnZXMgPSBwYXJzZUludChtYXRjaFsxXSA/PyAnMCcpXHJcbiAgICAgICAgICAgIGNvbnN0IG9sZE1lc3NhZ2VzID0gcGFyc2VJbnQobWF0Y2hbMl0gPz8gJzAnKVxyXG4gICAgICAgICAgICB2b2ljZW1haWwudmFsdWUgPSB7IG5ldzogbmV3TWVzc2FnZXMsIG9sZDogb2xkTWVzc2FnZXMgfVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIG5vdGlmaWNhdGlvbi5hY2NlcHQoKVxyXG4gICAgICAgIH0sXHJcbiAgICAgIH1cclxuICAgICAgLy8gSW5pY2lhciBVc2VyQWdlbnRcclxuICAgICAgYXdhaXQgdXNlckFnZW50LnZhbHVlLnN0YXJ0KClcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbmljaWFsaXphbmRvIFNJUDonLCBlcnIpXHJcbiAgICAgIGNvbm5lY3Rpb25TdGF0ZS52YWx1ZSA9ICdkaXNjb25uZWN0ZWQnXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBtYWtlQ2FsbCA9IGFzeW5jIChudW1iZXI6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKCF1c2VyQWdlbnQudmFsdWUgfHwgIWlzQ29ubmVjdGVkLnZhbHVlKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSVAgbm8gZXN0w6EgY29uZWN0YWRvJylcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgdGFyZ2V0ID0gbmV3IFVSSSgnc2lwJywgbnVtYmVyLCBzaXBDb25maWcudmFsdWUuZG9tYWluKVxyXG4gICAgICBjdXJyZW50Q2FsbC52YWx1ZSA9IG5ldyBJbnZpdGVyKHVzZXJBZ2VudC52YWx1ZSwgdGFyZ2V0KVxyXG5cclxuICAgICAgY2FsbFN0YXRlLnZhbHVlID0gJ2NhbGxpbmcnXHJcbiAgICAgIGNhbGxTdGFydFRpbWUudmFsdWUgPSBuZXcgRGF0ZSgpXHJcblxyXG4gICAgICAvLyBDb25maWd1cmFyIGV2ZW50b3MgcGFyYSBtYW5lamFyIGxhIGxsYW1hZGFcclxuICAgICAgY3VycmVudENhbGwudmFsdWUuc3RhdGVDaGFuZ2UuYWRkTGlzdGVuZXIoKHN0YXRlKSA9PiB7XHJcbiAgICAgICAgaWYgKHN0YXRlID09PSAnRXN0YWJsaXNoaW5nJykge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ0xsYW1hZGEgY3JlYWRhJylcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHN0YXRlID09PSAnRXN0YWJsaXNoZWQnKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnTGxhbWFkYSBjb250ZXN0YWRhJylcclxuICAgICAgICAgIGNhbGxTdGF0ZS52YWx1ZSA9ICdjb25uZWN0ZWQnXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzdGF0ZSA9PT0gJ1Rlcm1pbmF0ZWQnKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnTGxhbWFkYSB0ZXJtaW5hZGEnKVxyXG4gICAgICAgICAgY2FsbFN0YXRlLnZhbHVlID0gJ2VuZGVkJ1xyXG4gICAgICAgICAgY3VycmVudENhbGwudmFsdWUgPSBudWxsXHJcbiAgICAgICAgICBjYWxsU3RhcnRUaW1lLnZhbHVlID0gbnVsbFxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuXHJcbiAgICAgIGF3YWl0IGN1cnJlbnRDYWxsLnZhbHVlLmludml0ZSgpXHJcbiAgICAgIHJldHVybiB0cnVlXHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgaGFjaWVuZG8gbGxhbWFkYTonLCBlcnIpXHJcbiAgICAgIGNhbGxTdGF0ZS52YWx1ZSA9ICdpZGxlJ1xyXG4gICAgICBjdXJyZW50Q2FsbC52YWx1ZSA9IG51bGxcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCBlbmRDYWxsID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKGN1cnJlbnRDYWxsLnZhbHVlKSB7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRDYWxsLnZhbHVlIGluc3RhbmNlb2YgSW52aXRlcikge1xyXG4gICAgICAgICAgYXdhaXQgY3VycmVudENhbGwudmFsdWUuY2FuY2VsKClcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gYXdhaXQgY3VycmVudENhbGwudmFsdWUucmVqZWN0KClcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNhbGxTdGF0ZS52YWx1ZSA9ICdlbmRlZCdcclxuICAgICAgY3VycmVudENhbGwudmFsdWUgPSBudWxsXHJcbiAgICAgIGNhbGxTdGFydFRpbWUudmFsdWUgPSBudWxsXHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgdGVybWluYW5kbyBsbGFtYWRhOicsIGVycilcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IG11dGVDYWxsID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKGN1cnJlbnRDYWxsLnZhbHVlICYmIGNhbGxTdGF0ZS52YWx1ZSA9PT0gJ2Nvbm5lY3RlZCcpIHtcclxuICAgICAgICBjb25zdCBpbnYgPSBjdXJyZW50Q2FsbC52YWx1ZSBhcyBJbnZpdGVyIHwgSW52aXRhdGlvblxyXG4gICAgICAgIGNvbnN0IHNlc3Npb246IFNlc3Npb24gPSBpbnZcclxuICAgICAgICBzZXNzaW9uLm11dGUoKVxyXG5cclxuICAgICAgICAvLyBGYWxsYmFjazogbXV0ZSB1c2FuZG8gbWVkaWEgc3RyZWFtXHJcbiAgICAgICAgY29uc3QgbWVkaWFTdHJlYW0gPSBhd2FpdCBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh7IGF1ZGlvOiB0cnVlIH0pXHJcbiAgICAgICAgY29uc3QgYXVkaW9UcmFja3MgPSBtZWRpYVN0cmVhbS5nZXRBdWRpb1RyYWNrcygpXHJcbiAgICAgICAgYXVkaW9UcmFja3MuZm9yRWFjaCgodHJhY2s6IE1lZGlhU3RyZWFtVHJhY2spID0+IHtcclxuICAgICAgICAgIHRyYWNrLmVuYWJsZWQgPSBmYWxzZVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgaXNNdXRlZC52YWx1ZSA9IHRydWVcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIG11dGluZyBjYWxsOicsIGVycilcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IHVubXV0ZUNhbGwgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBpZiAoY3VycmVudENhbGwudmFsdWUgJiYgY2FsbFN0YXRlLnZhbHVlID09PSAnY29ubmVjdGVkJykge1xyXG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSBjdXJyZW50Q2FsbC52YWx1ZSBhcyB1bmtub3duIGFzIFNlc3Npb25cclxuXHJcbiAgICAgICAgLy8gVXNhciBlbCBtw6l0b2RvIG5hdGl2byBkZSBTSVAuanMgcGFyYSB1bm11dGVcclxuICAgICAgICBpZiAoc2Vzc2lvbiAmJiB0eXBlb2Ygc2Vzc2lvbi51bm11dGUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHNlc3Npb24udW5tdXRlKClcclxuICAgICAgICAgIGlzTXV0ZWQudmFsdWUgPSBmYWxzZVxyXG4gICAgICAgICAgY29uc29sZS5sb2coJ0NhbGwgdW5tdXRlZCcpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIEZhbGxiYWNrOiB1bm11dGUgdXNhbmRvIG1lZGlhIHN0cmVhbVxyXG4gICAgICAgICAgY29uc3QgbWVkaWFTdHJlYW0gPSBhd2FpdCBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh7IGF1ZGlvOiB0cnVlIH0pXHJcbiAgICAgICAgICBjb25zdCBhdWRpb1RyYWNrcyA9IG1lZGlhU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClcclxuICAgICAgICAgIGF1ZGlvVHJhY2tzLmZvckVhY2goKHRyYWNrOiBNZWRpYVN0cmVhbVRyYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIHRyYWNrLmVuYWJsZWQgPSB0cnVlXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgaXNNdXRlZC52YWx1ZSA9IGZhbHNlXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgdW5tdXRpbmcgY2FsbDonLCBlcnIpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdCB0b2dnbGVNdXRlID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgaWYgKGlzTXV0ZWQudmFsdWUpIHtcclxuICAgICAgYXdhaXQgdW5tdXRlQ2FsbCgpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBhd2FpdCBtdXRlQ2FsbCgpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgdXNlckFnZW50LFxyXG4gICAgaXNSZWdpc3RlcmVkLFxyXG4gICAgaXNDb25uZWN0ZWQsXHJcbiAgICBjb25uZWN0aW9uU3RhdGUsXHJcbiAgICBlcnJvcixcclxuICAgIHNpcENvbmZpZyxcclxuICAgIGN1cnJlbnRDYWxsLFxyXG4gICAgaW5jb21pbmdDYWxsLFxyXG4gICAgdm9pY2VtYWlsLFxyXG4gICAgaXNEbmQsXHJcbiAgICBjYWxsU3RhdGUsXHJcbiAgICBjYWxsU3RhcnRUaW1lLFxyXG4gICAgbWFrZUNhbGwsXHJcbiAgICBlbmRDYWxsLFxyXG4gICAgaW5pdGlhbGl6ZVNpcCxcclxuICB9XHJcbn0pXHJcbiJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBUyxtQkFBbUI7QUFDNUIsU0FBUyxTQUFTLEtBQUssV0FBVyxTQUFTLFlBQVksb0JBQW9CO0FBRTNFLFNBQVMsV0FBVztBQUViLGFBQU0sY0FBYyxZQUFZLE9BQU8sTUFBTTtBQUNsRCxRQUFNLFlBQVks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